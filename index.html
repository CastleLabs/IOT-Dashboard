<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>IOT System Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Color System - Matches AV Dashboard */
            --color-primary: #2563eb;
            --color-primary-hover: #1d4ed8;
            --color-secondary: #64748b;
            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-danger: #ef4444;
            --color-danger-hover: #dc2626;
            
            /* Neutral Colors */
            --color-background: #0f172a;
            --color-surface: #1e293b;
            --color-surface-hover: #334155;
            --color-border: #334155;
            --color-border-light: #475569;
            
            /* Text Colors */
            --color-text-primary: #f8fafc;
            --color-text-secondary: #cbd5e1;
            --color-text-muted: #64748b;
            
            /* Spacing */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-2xl: 3rem;
            
            /* Border Radius */
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            
            /* Transitions */
            --transition-fast: 0.15s ease;
            --transition-base: 0.2s ease;
            --transition-slow: 0.3s ease;
            
            /* Font Weights */
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;
        }

        /* Reset & Base Styles */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px;
            line-height: 1.5;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--color-background);
            color: var(--color-text-primary);
            font-weight: var(--font-weight-normal);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Layout */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--spacing-lg);
        }

        /* Header */
        .header {
            margin-bottom: var(--spacing-xl);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--color-surface);
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--color-border);
        }

        .header-title {
            font-size: 1.875rem;
            font-weight: var(--font-weight-bold);
            color: var(--color-text-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .header-actions {
            display: flex;
            gap: var(--spacing-md);
            align-items: center;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            border: none;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: var(--font-weight-medium);
            text-decoration: none;
            cursor: pointer;
            transition: all var(--transition-base);
            user-select: none;
            min-height: 44px; /* iOS minimum touch target */
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background-color: var(--color-primary);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: var(--color-primary-hover);
        }

        .btn-secondary {
            background-color: var(--color-surface-hover);
            color: var(--color-text-primary);
            border: 1px solid var(--color-border-light);
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: var(--color-border-light);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
        }

        .stat-card {
            background-color: var(--color-surface);
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            text-align: center;
            border: 1px solid var(--color-border);
            transition: transform var(--transition-base);
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
            line-height: 1;
        }

        .stat-label {
            margin-top: var(--spacing-sm);
            font-size: 0.875rem;
            color: var(--color-text-secondary);
            font-weight: var(--font-weight-medium);
        }

        /* Navigation */
        .nav-container {
            position: relative;
            margin-bottom: var(--spacing-lg);
        }

        .nav-menu {
            display: flex;
            gap: var(--spacing-xs);
            overflow-x: auto;
            padding-bottom: var(--spacing-xs);
            -webkit-overflow-scrolling: touch;
        }

        .nav-item {
            padding: var(--spacing-sm) var(--spacing-md);
            background-color: var(--color-surface);
            color: var(--color-text-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-base);
            white-space: nowrap;
            font-weight: var(--font-weight-medium);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            min-height: 44px;
        }

        .nav-item:hover {
            background-color: var(--color-surface-hover);
            color: var(--color-text-primary);
        }

        .nav-item.active {
            background-color: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        /* Content */
        .content {
            min-height: 400px;
        }

        .section-container {
            margin-bottom: var(--spacing-2xl);
        }

        .section-header {
            font-size: 1.25rem;
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--spacing-lg);
            color: var(--color-text-primary);
            padding-bottom: var(--spacing-sm);
            border-bottom: 2px solid var(--color-border);
        }

        /* Device Grid */
        .device-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: var(--spacing-lg);
        }

        .device-card {
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            overflow: hidden;
            transition: all var(--transition-base);
            box-shadow: var(--shadow-sm);
        }

        .device-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--color-border-light);
        }

        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md) var(--spacing-lg);
            background-color: rgba(255, 255, 255, 0.02);
            border-bottom: 1px solid var(--color-border);
        }

        .device-name {
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            font-size: 1rem;
        }

        .device-category {
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: var(--font-weight-medium);
            background-color: var(--color-primary);
            color: white;
        }

        .device-content {
            padding: var(--spacing-lg);
        }

        .device-info {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: var(--spacing-sm) var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .device-label {
            color: var(--color-text-secondary);
            font-size: 0.875rem;
            font-weight: var(--font-weight-medium);
        }

        .device-value {
            color: var(--color-text-primary);
            font-size: 0.875rem;
        }

        .device-value a {
            color: var(--color-primary);
            text-decoration: none;
            transition: color var(--transition-base);
        }

        .device-value a:hover {
            color: var(--color-primary-hover);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: var(--font-weight-medium);
            text-transform: capitalize;
        }

        .status-badge::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .status-online {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--color-success);
        }

        .status-online::before {
            background-color: var(--color-success);
            animation: pulse 2s infinite;
        }

        .status-offline {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--color-danger);
        }

        .status-offline::before {
            background-color: var(--color-danger);
        }

        .status-checking {
            background-color: rgba(245, 158, 11, 0.1);
            color: var(--color-warning);
        }

        .status-checking::before {
            background-color: var(--color-warning);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .device-actions {
            display: flex;
            gap: var(--spacing-sm);
        }

        .device-actions .btn {
            flex: 1;
            justify-content: center;
            min-height: 44px;
        }

        .btn-small {
            padding: var(--spacing-sm) var(--spacing-md);
            font-size: 0.875rem;
            min-height: 44px;
        }

        /* Alert Banner */
        .alert {
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-lg);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .alert-info {
            background-color: rgba(37, 99, 235, 0.1);
            color: var(--color-primary);
            border: 1px solid rgba(37, 99, 235, 0.2);
        }

        .alert-success {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--color-success);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .alert-error {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--color-danger);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .alert-warning {
            background-color: rgba(245, 158, 11, 0.1);
            color: var(--color-warning);
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        .alert.hidden {
            display: none;
        }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 1em;
            height: 1em;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Debug Panel */
        .debug-panel {
            position: fixed;
            bottom: var(--spacing-md);
            right: var(--spacing-md);
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: var(--spacing-sm);
            font-size: 0.75rem;
            color: var(--color-text-secondary);
            z-index: 1000;
            max-width: 300px;
            word-wrap: break-word;
        }

        .debug-panel.hidden {
            display: none;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .device-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            }
            
            .header-content {
                flex-direction: column;
                gap: var(--spacing-md);
                text-align: center;
            }
            
            .header-actions {
                flex-wrap: wrap;
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: var(--spacing-md);
            }
            
            .device-grid {
                grid-template-columns: 1fr;
                gap: var(--spacing-md);
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: var(--spacing-sm);
            }
            
            .nav-menu {
                flex-direction: column;
                gap: var(--spacing-sm);
            }
            
            .nav-item {
                width: 100%;
                justify-content: center;
            }
            
            .device-actions {
                flex-direction: column;
                gap: var(--spacing-sm);
            }
            
            .device-actions .btn {
                width: 100%;
            }
            
            .header-actions {
                flex-direction: column;
                width: 100%;
            }
            
            .header-actions .btn {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .device-info {
                grid-template-columns: 1fr;
                gap: var(--spacing-xs);
                text-align: center;
            }
            
            .device-header {
                flex-direction: column;
                gap: var(--spacing-sm);
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-content">
                <h1 class="header-title">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    IOT System Dashboard
                </h1>
                <div class="header-actions">
                    <button id="refresh-all" class="btn btn-secondary" title="Refresh All Status">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
                            <path d="M21 3v5h-5"></path>
                            <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
                            <path d="M3 21v-5h5"></path>
                        </svg>
                        Refresh
                    </button>
                    <a href="edit.php" class="btn btn-primary">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 5v14"></path>
                            <path d="M5 12h14"></path>
                        </svg>
                        Add/Edit
                    </a>
                    <a href="http://192.168.8.127/devices" class="btn btn-secondary">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                            <line x1="8" y1="21" x2="16" y2="21"></line>
                            <line x1="12" y1="17" x2="12" y2="21"></line>
                        </svg>
                        AV Dashboard
                    </a>
                    <button id="debug-toggle" class="btn btn-secondary" title="Toggle Debug">Debug</button>
                </div>
            </div>
        </header>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="total-devices">0</div>
                <div class="stat-label">Total Devices</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-categories">0</div>
                <div class="stat-label">Categories</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="online-devices">0</div>
                <div class="stat-label">Online</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="offline-devices">0</div>
                <div class="stat-label">Offline</div>
            </div>
        </div>

        <nav class="nav-container">
            <div class="nav-menu" id="nav-menu">
                <a href="#" class="nav-item active" data-section="all">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    </svg>
                    All Devices
                </a>
            </div>
        </nav>

        <div id="alert-container">
            <div id="alert" class="alert alert-info hidden">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M12 6v6l4 2"></path>
                </svg>
                <span id="alert-message"></span>
            </div>
        </div>

        <main class="content">
            <div id="dashboard-content">
                <!-- Sections will be inserted here -->
            </div>
        </main>
    </div>

    <div id="debug-panel" class="debug-panel hidden">
        <div id="debug-content">Debug info will appear here...</div>
    </div>

    <script>
        class IOTDashboard {
            constructor() {
                this.devices = {};
                this.statusChecks = new Map();
                this.currentSection = 'all';
                this.debug = false;
                this.lastStatusCheck = 0;
                this.checkInProgress = false;
                this.retryAttempts = new Map();
                this.maxRetries = 3;
                this.statusCheckInterval = null;
                
                this.init();
            }

            init() {
                this.log('Initializing IOT Dashboard...');
                this.setupEventListeners();
                this.loadConfiguration();
            }

            log(message, data = null) {
                if (this.debug) {
                    const timestamp = new Date().toLocaleTimeString();
                    const logMessage = `[${timestamp}] ${message}`;
                    console.log(logMessage, data || '');
                    this.updateDebugPanel(logMessage + (data ? ` | Data: ${JSON.stringify(data)}` : ''));
                }
            }

            updateDebugPanel(message) {
                const debugPanel = document.getElementById('debug-content');
                if (debugPanel) {
                    const currentContent = debugPanel.innerHTML;
                    const lines = currentContent.split('<br>');
                    lines.unshift(message);
                    if (lines.length > 10) lines.pop(); // Keep only last 10 messages
                    debugPanel.innerHTML = lines.join('<br>');
                }
            }

            setupEventListeners() {
                this.log('Setting up event listeners...');
                
                // Refresh button with debouncing
                const refreshBtn = document.getElementById('refresh-all');
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', this.debounce(() => {
                        this.refreshAllDevices();
                    }, 1000));
                }

                // Debug toggle
                const debugBtn = document.getElementById('debug-toggle');
                if (debugBtn) {
                    debugBtn.addEventListener('click', () => {
                        this.debug = !this.debug;
                        const debugPanel = document.getElementById('debug-panel');
                        if (debugPanel) {
                            debugPanel.classList.toggle('hidden', !this.debug);
                        }
                        this.log(`Debug mode ${this.debug ? 'enabled' : 'disabled'}`);
                    });
                }

                // Navigation with proper event delegation
                document.addEventListener('click', (e) => {
                    if (e.target.closest('.nav-item')) {
                        e.preventDefault();
                        this.handleNavigation(e.target.closest('.nav-item'));
                    }
                });

                // Handle visibility change to pause/resume checking
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        this.pauseStatusChecking();
                    } else {
                        this.resumeStatusChecking();
                    }
                });
            }

            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            async loadConfiguration() {
                try {
                    this.log('Loading configuration from DBconfigs.ini...');
                    this.showAlert('Loading configuration...', 'info');
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => {
                        controller.abort();
                        this.log('Configuration load timed out');
                    }, 10000);
                    
                    const response = await fetch('DBconfigs.ini', {
                        signal: controller.signal,
                        cache: 'no-cache'
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const configText = await response.text();
                    if (!configText.trim()) {
                        throw new Error('Configuration file is empty');
                    }
                    
                    this.log('Configuration loaded, parsing...');
                    this.devices = this.parseConfig(configText);
                    this.log('Configuration parsed', { deviceCount: Object.keys(this.devices).length });
                    
                    this.updateStats();
                    this.renderNavigation();
                    this.renderDevices();
                    
                    this.showAlert('Configuration loaded successfully', 'success');
                    
                    // Start status checking after config is loaded
                    this.startStatusChecking();
                    
                } catch (error) {
                    this.log('Configuration load error', error);
                    if (error.name === 'AbortError') {
                        this.showAlert('Configuration load timed out. Check network connection.', 'error');
                    } else {
                        this.showAlert(`Failed to load configuration: ${error.message}`, 'error');
                    }
                    
                    // Show fallback message
                    this.renderFallbackContent();
                }
            }

            renderFallbackContent() {
                const content = document.getElementById('dashboard-content');
                content.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--color-text-muted);">
                        <h3>Configuration Error</h3>
                        <p>Unable to load device configuration. Please check:</p>
                        <ul style="text-align: left; max-width: 400px; margin: 1rem auto;">
                            <li>DBconfigs.ini file exists and is readable</li>
                            <li>Web server has proper permissions</li>
                            <li>Network connectivity</li>
                        </ul>
                        <button onclick="location.reload()" class="btn btn-primary" style="margin-top: 1rem;">
                            Retry
                        </button>
                    </div>
                `;
            }

            parseConfig(configText) {
                const devices = {};
                let currentSection = '';
                
                const lines = configText.split('\n');
                this.log(`Parsing ${lines.length} lines of configuration`);
                
                lines.forEach((line, index) => {
                    line = line.trim();
                    
                    if (line.startsWith('[') && line.endsWith(']')) {
                        currentSection = line.slice(1, -1);
                        devices[currentSection] = {};
                        this.log(`Found section: ${currentSection}`);
                    } else if (line && currentSection && line.includes('=')) {
                        const [name, address] = line.split('=').map(s => s.trim());
                        if (name && address) {
                            devices[currentSection][name] = {
                                address: address,
                                status: 'checking',
                                lastChecked: null,
                                retryCount: 0
                            };
                        }
                    }
                });
                
                return devices;
            }

            updateStats() {
                let totalDevices = 0;
                let onlineDevices = 0;
                let offlineDevices = 0;
                
                Object.values(this.devices).forEach(category => {
                    Object.values(category).forEach(device => {
                        totalDevices++;
                        if (device.status === 'online') onlineDevices++;
                        else if (device.status === 'offline') offlineDevices++;
                    });
                });
                
                document.getElementById('total-devices').textContent = totalDevices;
                document.getElementById('total-categories').textContent = Object.keys(this.devices).length;
                document.getElementById('online-devices').textContent = onlineDevices;
                document.getElementById('offline-devices').textContent = offlineDevices;
                
                this.log('Stats updated', { total: totalDevices, online: onlineDevices, offline: offlineDevices });
            }

            renderNavigation() {
                const navMenu = document.getElementById('nav-menu');
                const sections = Object.keys(this.devices);
                
                // Keep "All Devices" and add category sections
                let navHTML = `
                    <a href="#" class="nav-item active" data-section="all">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        </svg>
                        All Devices
                    </a>
                `;
                
                sections.forEach(section => {
                    navHTML += `
                        <a href="#" class="nav-item" data-section="${section}">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="3"></circle>
                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2 2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V12a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                            </svg>
                            ${section}
                        </a>
                    `;
                });
                
                navMenu.innerHTML = navHTML;
                this.log('Navigation rendered', { sections: sections.length });
            }

            handleNavigation(target) {
                this.log(`Navigation clicked: ${target.dataset.section}`);
                
                // Update active state
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                target.classList.add('active');
                
                this.currentSection = target.dataset.section;
                this.renderDevices();
            }

            renderDevices() {
                const content = document.getElementById('dashboard-content');
                content.innerHTML = '';
                
                this.log(`Rendering devices for section: ${this.currentSection}`);
                
                if (this.currentSection === 'all') {
                    // Render all categories
                    Object.entries(this.devices).forEach(([categoryName, devices]) => {
                        if (Object.keys(devices).length > 0) {
                            content.appendChild(this.createSectionContainer(categoryName, devices));
                        }
                    });
                } else {
                    // Render specific category
                    const devices = this.devices[this.currentSection] || {};
                    if (Object.keys(devices).length > 0) {
                        content.appendChild(this.createSectionContainer(this.currentSection, devices));
                    } else {
                        content.innerHTML = '<div class="empty-state">No devices found in this category.</div>';
                    }
                }
            }

            createSectionContainer(categoryName, devices) {
                const section = document.createElement('div');
                section.className = 'section-container';
                
                const header = document.createElement('h2');
                header.className = 'section-header';
                header.textContent = categoryName;
                section.appendChild(header);
                
                const grid = document.createElement('div');
                grid.className = 'device-grid';
                
                Object.entries(devices).forEach(([deviceName, deviceData]) => {
                    grid.appendChild(this.createDeviceCard(deviceName, deviceData, categoryName));
                });
                
                section.appendChild(grid);
                return section;
            }

            createDeviceCard(deviceName, deviceData, categoryName) {
                const card = document.createElement('div');
                card.className = 'device-card';
                card.dataset.deviceKey = `${categoryName}:${deviceName}`;
                
                const lastCheckedText = deviceData.lastChecked 
                    ? `Last checked: ${new Date(deviceData.lastChecked).toLocaleTimeString()}`
                    : 'Never checked';
                
                card.innerHTML = `
                    <div class="device-header">
                        <div class="device-name">${this.escapeHtml(deviceName)}</div>
                        <div class="device-category">${this.escapeHtml(categoryName)}</div>
                    </div>
                    <div class="device-content">
                        <div class="device-info">
                            <div class="device-label">Address:</div>
                            <div class="device-value">
                                <a href="http://${this.escapeHtml(deviceData.address)}" target="_blank" rel="noopener">${this.escapeHtml(deviceData.address)}</a>
                            </div>
                            <div class="device-label">Status:</div>
                            <div class="device-value">
                                <span class="status-badge status-${deviceData.status}">${deviceData.status}</span>
                            </div>
                            <div class="device-label">Last Check:</div>
                            <div class="device-value">${lastCheckedText}</div>
                        </div>
                        <div class="device-actions">
                            <a href="http://${this.escapeHtml(deviceData.address)}" target="_blank" rel="noopener" class="btn btn-secondary">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                    <polyline points="15,3 21,3 21,9"></polyline>
                                    <line x1="10" y1="14" x2="21" y2="3"></line>
                                </svg>
                                Open Device
                            </a>
                            <button class="btn btn-secondary btn-small check-device" data-category="${categoryName}" data-name="${deviceName}" data-address="${deviceData.address}">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
                                    <path d="M21 3v5h-5"></path>
                                    <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
                                    <path d="M3 21v-5h5"></path>
                                </svg>
                                Check Now
                            </button>
                        </div>
                    </div>
                `;
                
                // Add click handler for individual check
                const checkBtn = card.querySelector('.check-device');
                checkBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const btn = e.currentTarget;
                    const category = btn.dataset.category;
                    const name = btn.dataset.name;
                    const address = btn.dataset.address;
                    
                    await this.checkSingleDeviceWithUI(btn, category, name, address);
                });
                
                return card;
            }

            async checkSingleDeviceWithUI(btn, category, deviceName, address) {
                // Show loading state
                btn.disabled = true;
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<span class="spinner"></span>Checking...';
                
                // Update status badge to checking
                const card = btn.closest('.device-card');
                const statusBadge = card.querySelector('.status-badge');
                statusBadge.className = 'status-badge status-checking';
                statusBadge.textContent = 'checking';
                
                try {
                    // Check the device
                    await this.checkSingleDevice(category, deviceName, address);
                    this.log(`Manual check completed for ${deviceName}`);
                } catch (error) {
                    this.log(`Manual check failed for ${deviceName}`, error);
                }
                
                // Reset button after delay
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = originalHTML;
                }, 1000);
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            async startStatusChecking() {
                this.log('Starting automatic status checking...');
                
                // Initial check
                await this.checkAllDevices();
                
                // Then check every 2 minutes
                this.statusCheckInterval = setInterval(async () => {
                    if (!document.hidden && !this.checkInProgress) {
                        await this.checkAllDevices();
                    }
                }, 120000);
            }

            pauseStatusChecking() {
                this.log('Pausing status checking (page hidden)');
                if (this.statusCheckInterval) {
                    clearInterval(this.statusCheckInterval);
                    this.statusCheckInterval = null;
                }
            }

            resumeStatusChecking() {
                this.log('Resuming status checking (page visible)');
                if (!this.statusCheckInterval) {
                    this.startStatusChecking();
                }
            }

            async checkAllDevices() {
                if (this.checkInProgress) {
                    this.log('Status check already in progress, skipping');
                    return;
                }

                const now = Date.now();
                if (now - this.lastStatusCheck < 10000) { // Reduced from 30 seconds to 10 seconds
                    this.log('Status check too recent, skipping');
                    return;
                }

                this.checkInProgress = true;
                this.lastStatusCheck = now;

                try {
                    this.log('Starting status check...');
                    
                    const response = await fetch('status.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            action: 'check_all'
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    
                    if (data.success && data.results) {
                        this.log('Status check successful', { count: data.count });
                        
                        // Update device statuses
                        Object.entries(data.results).forEach(([deviceKey, status]) => {
                            const [category, name] = deviceKey.split(':');
                            if (this.devices[category] && this.devices[category][name]) {
                                this.devices[category][name].status = status;
                                this.devices[category][name].lastChecked = now;
                                this.updateDeviceStatus(category, name, status);
                            }
                        });
                        
                        this.updateStats();
                        this.showAlert(`Status updated: ${data.count} devices checked`, 'success');
                    } else {
                        throw new Error(data.error || 'Unknown error from status.php');
                    }
                } catch (error) {
                    this.log('Status check failed', error);
                    this.showAlert(`Status check failed: ${error.message}`, 'error');
                } finally {
                    this.checkInProgress = false;
                }
            }

            async checkSingleDevice(category, deviceName, address) {
                try {
                    this.log(`Checking single device: ${deviceName}`);
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 8000);
                    
                    const response = await fetch('status.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            action: 'check_single',
                            address: address,
                            key: `${category}:${deviceName}`
                        }),
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    const responseText = await response.text();
                    const data = JSON.parse(responseText);
                    
                    if (data.success) {
                        this.devices[category][deviceName].status = data.status;
                        this.devices[category][deviceName].lastChecked = Date.now();
                        this.updateDeviceStatus(category, deviceName, data.status);
                        this.updateStats();
                        this.log(`Single device check successful: ${deviceName} is ${data.status}`);
                    } else {
                        throw new Error(data.error || 'Unknown error');
                    }
                } catch (error) {
                    this.log(`Failed to check ${deviceName}`, error);
                    // Set as offline if check fails
                    this.devices[category][deviceName].status = 'offline';
                    this.devices[category][deviceName].lastChecked = Date.now();
                    this.updateDeviceStatus(category, deviceName, 'offline');
                    this.updateStats();
                }
            }

            updateDeviceStatus(categoryName, deviceName, status) {
                const deviceKey = `${categoryName}:${deviceName}`;
                const card = document.querySelector(`[data-device-key="${deviceKey}"]`);
                
                if (card) {
                    const statusBadge = card.querySelector('.status-badge');
                    if (statusBadge) {
                        statusBadge.className = `status-badge status-${status}`;
                        statusBadge.textContent = status;
                    }
                    
                    // Update last checked time
                    const lastCheckedElement = card.querySelector('.device-info .device-value:last-child');
                    if (lastCheckedElement) {
                        lastCheckedElement.textContent = `Last checked: ${new Date().toLocaleTimeString()}`;
                    }
                }
            }

            async refreshAllDevices() {
                const btn = document.getElementById('refresh-all');
                btn.disabled = true;
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<span class="spinner"></span>Refreshing...';
                
                try {
                    this.log('Manual refresh initiated');
                    this.lastStatusCheck = 0; // Reset to force immediate check
                    await this.checkAllDevices();
                    this.showAlert('Device status refreshed successfully', 'success');
                } catch (error) {
                    this.log('Manual refresh failed', error);
                    this.showAlert('Error refreshing device status', 'error');
                } finally {
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.innerHTML = originalHTML;
                    }, 1000);
                }
            }

            showAlert(message, type = 'info') {
                const alert = document.getElementById('alert');
                const alertMessage = document.getElementById('alert-message');
                
                alert.className = `alert alert-${type}`;
                alertMessage.textContent = message;
                alert.classList.remove('hidden');
                
                this.log(`Alert: ${type} - ${message}`);
                
                // Auto-hide success messages
                if (type === 'success') {
                    setTimeout(() => {
                        alert.classList.add('hidden');
                    }, 3000);
                } else if (type === 'error') {
                    // Keep error messages visible longer
                    setTimeout(() => {
                        alert.classList.add('hidden');
                    }, 8000);
                }
            }
        }

        // Initialize dashboard when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            new IOTDashboard();
        });
    </script>
</body>
</html>
